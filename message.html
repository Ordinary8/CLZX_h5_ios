<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet" />
    <script src="jquery/jquery-1.8.3.min.js"></script>
    <style>
    html,
    body {
        height: 100%;
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
    }
    footer {
        position: fixed;
        width: 100%;
        height: 50px;
        min-height: 50px;
        border-top: solid 1px #bbb;
        left: 0px;
        bottom: 0px;
        overflow: hidden;
        background-color: #fafafa;
    }
    .footer-right {
        position: absolute;
        width: 50px;
        height: 50px;
        right: 0px;
        bottom: 0px;
        text-align: center;
        vertical-align: middle;
        line-height: 100%;
        padding: 5px 5px 5px 0;
        display: inline-block;
    }
    .footer-center {
        height: 100%;
        padding: 5px 45px 5px 0;
    }
    .footer-center [class*=input] {
        width: 100%;
        height: 100%;
        border-radius: 5px;
    }
    .footer-center .input-text {
        background: #fff;
        border: solid 1px #ddd;
        padding: 10px !important;
        font-size: 16px !important;
        line-height: 18px !important;
        font-family: verdana !important;
        overflow: hidden;
    }
    .footer-center .input-sound {
        background-color: #eee;
    }
    .mui-content {
        height: 100%;
        padding: 44px 0px 50px 0px;
        overflow: auto;
        background-color: #eaeaea;
    }
    #msg-list {
        padding: 10px 0;
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }
    .msg-item {
        padding: 8px;
        clear: both;
    }
    .msg-item .mui-item-clear {
        clear: both;
    }
    .msg-item .msg-user {
        width: 38px;
        height: 38px;
        border: solid 1px #d3d3d3;
        display: inline-block;
        background: #fff;
        border-radius: 3px;
        vertical-align: top;
        text-align: center;
        float: left;
        padding: 3px;
        color: #ddd;
    }

    .msg-item .msg-user-img{
        width: 38px;
        height: 38px;
        display: inline-block;
        border-radius: 3px;
        vertical-align: top;
        text-align: center;
        float: left;
        color: #ddd;
    }

    .msg-item .msg-content {
        display: inline-block;
        border-radius: 5px;
        border: solid 1px #d3d3d3;
        background-color: #FFFFFF;
        color: #333;
        padding: 8px;
        vertical-align: top;
        font-size: 15px;
        position: relative;
        margin: 0px 8px;
        max-width: 75%;
        min-width: 35px;
        float: left;
    }
    .msg-item .msg-content .msg-content-inner {
        overflow-x: hidden;
    }
    .msg-item .msg-content .msg-content-arrow {
        position: absolute;
        border: solid 1px #d3d3d3;
        border-right: none;
        border-top: none;
        background-color: #FFFFFF;
        width: 10px;
        height: 10px;
        left: -5px;
        top: 12px;
        -webkit-transform: rotateZ(45deg);
        transform: rotateZ(45deg);
    }
    .msg-item-self .msg-user,
    .msg-item-self .msg-content {
        float: right;
    }
    .msg-item-self .msg-content .msg-content-arrow {
        left: auto;
        right: -5px;
        -webkit-transform: rotateZ(225deg);
        transform: rotateZ(225deg);
    }
    .msg-item-self .msg-content,
    .msg-item-self .msg-content .msg-content-arrow {
        background-color: #4CD964;
        color: #fff;
        border-color: #2AC845;
    }
    footer .mui-icon {
        color: #000;
    }
    footer .mui-icon:active {
        color: #007AFF !important;
    }
    footer .mui-icon-paperplane {
        /*-webkit-transform: rotateZ(45deg);
        transform: rotateZ(45deg);*/

        font-size: 16px;
        word-break: keep-all;
        line-height: 100%;
        padding-top: 6px;
        color: rgba(0, 135, 250, 1);
    }

    .rprogress {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 140px;
        height: 140px;
        margin-left: -70px;
        margin-top: -70px;
        background-image: url(img/bg.png);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 30px 30px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 5px;
        display: none;
        -webkit-transition: .15s;
    }
    .rschedule {
        background-color: rgba(0, 0, 0, 0);
        border: 5px solid rgba(0, 183, 229, 0.9);
        opacity: .9;
        border-left: 5px solid rgba(0, 0, 0, 0);
        border-right: 5px solid rgba(0, 0, 0, 0);
        border-radius: 50px;
        box-shadow: 0 0 15px #2187e7;
        width: 46px;
        height: 46px;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -23px;
        margin-top: -23px;
        -webkit-animation: spin 1s infinite linear;
        animation: spin 1s infinite linear;
    }
    .r-sigh{
        display: none;
        border-radius: 50px;
        box-shadow: 0 0 15px #2187e7;
        width: 46px;
        height: 46px;
        position: absolute;
        left: 50%;
        top: 50%;
        margin-left: -23px;
        margin-top: -23px;
        text-align: center;
        line-height: 46px;
        font-size: 40px;
        font-weight: bold;
        color: #2187e7;
    }
    .rprogress-sigh{
        background-image: none !important;
    }
    .rprogress-sigh .rschedule{
        display: none !important;
    }
    .rprogress-sigh .r-sigh{
        display: block !important;
    }
    .rsalert {
        font-size: 12px;
        color: #bbb;
        text-align: center;
        position: absolute;
        border-radius: 5px;
        width: 130px;
        margin: 5px 5px;
        padding: 5px;
        left: 0px;
        bottom: 0px;
    }
    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    #h {
        background: #fff;
        border: solid 1px #ddd;
        padding: 10px !important;
        font-size: 16px !important;
        font-family: verdana !important;
        line-height: 18px !important;
        overflow: visible;
        position: absolute;
        left: -1000px;
        right: 0px;
        word-break: break-all;
        word-wrap: break-word;
    }
    .cancel {
        background-color: darkred;
    }
    .status_bar{  background-color: #fff;
        height: 20px;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1033;
    }
    </style>
</head>
<body>
<header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="back"></a>
    <h1 class="mui-title">我的消息</h1>
</header>
<div class="mui-content">
    <div id='msg-list'>
    </div>
</div>
<footer class="mui-bar mui-bar-footer">
    <div class="footer-center">
        <textarea id='msg-text' type="text" class='input-text'></textarea>
    </div>
    <div class="footer-right">
        <i id='btn-submit' class="mui-icon mui-icon-paperplane" style="font-size: 28px;"></i>
    </div>
</footer>
<script src="js/globalVar.js"></script>
<script>
    if(parent==window){
        var script = document.createElement("script");
        script.type = "application/javascript";
        script.src = "cordova.js";
        document.body.appendChild(script);
    }
    
    $(document).ready(function(){
        autoMessage();
        localStorage.removeItem('unReadMsg');//删除未读消息数字
        if(parent.hideStatusBar)
            parent.hideStatusBar();
        $("#back").on("touchend",function(){back()});
    });
    var myDom={//获取Dom
        msgText:$("#msg-text"),
        btnSubmit:$("#btn-submit"),
        msgList:$("#msg-list")
    };
    myDom.msgText.focus(function(){//给输入框绑定输入事件
        submitBind();
    });
    var submitBind=function(){//按钮改变，并给按钮绑定点击事件
        myDom.btnSubmit.removeClass("iconfont icon-jianpan");
        myDom.btnSubmit.addClass("mui-icon-paperplane");
        myDom.btnSubmit.bind("click",function(){
            var textVal=myDom.msgText.val();//输入框的值
            render(textVal);
            myDom.msgText.val("");
            if(myDom.msgText.val()==""){
                myDom.btnSubmit.unbind();
            }

        })
    };
    var render=function(textVal){//添加输入的内容，并向服务器发送数据，并将渲染返回的数据
        var textValue=textVal.replace(new RegExp('\n', 'gm'), '<br/>');//输入框内容处理
        myDom.msgList.append('<div class="msg-item msg-item-self"><i class="msg-user mui-icon mui-icon-person"></i><div class="msg-content"><div class="msg-content-inner"> '
  +textValue+'</div><div class="msg-content-arrow"></div></div>');

        var url="http://api.wisegps.cn/"+ "customer/"+customer_id+"/send_chat?auth_code="+auth_code;//发送消息
        $.post(url,{
                    type:"0",
                    cust_name:userName,
                    content:textVal,
                    friend_id:parentId,
                    url:"",
                    voice_len:0,
                    lat:0,
                    lon:0,
                    address:""
                },function(data){
                    if(data.status_code)
                        alert("发送失败！")
                }
        );
        //myDom.msgList.scrollTop(myDom.msgList.scrollHeight+myDom.msgList.offsetHeight);
        scrollToBottom();

    };
    function scrollToBottom(){
        myDom.msgList[0].scrollTop=myDom.msgList[0].scrollHeight-myDom.msgList.height();
    }
    var msgData;//获取消息保存
    var msgLen=0;//获取的消息条数
    var autoMessage=function(){//每隔10秒自动获取消息
        var url="http://api.wisegps.cn/"+"customer/"+customer_id+"/get_chats?auth_code="+auth_code+"&friend_id="
                +parentId;//获取消息url
        if(msgLen!=0){
            if(msgData.length){
                url="http://api.wisegps.cn/"+"customer/"+customer_id+"/get_chats?auth_code="+auth_code+"&friend_id="
                        +parentId+"&min_id="+msgData[0].chat_id;
            }
        }
        $.get(url,function(data){
            if(msgData)
                msgData=data.concat(msgData);
            else
                msgData=data;
            var buffHtml="";
            for(var i=data.length-1;i>=0;i--){
                var textValue=data[i].content.replace(new RegExp('\n', 'gm'), '<br/>');//获取消息内容处理
                if(data[i].sender_id==customer_id){
                    buffHtml+='<div class="msg-item msg-item-self"><i class="msg-user mui-icon mui-icon-person"></i><div class="msg-content"><div class="msg-content-inner"> '+textValue+'</div><div class="msg-content-arrow"></div></div></div>';
                }else{
                    buffHtml+='<div class="msg-item"><img class="msg-user-img" src="./image/chat_default_service.png" alt="" /><div class="msg-content"><div class="msg-content-inner"> '+textValue+'</div><div class="msg-content-arrow"></div></div></div>';
                }
            }
            myDom.msgList.append(buffHtml);
            scrollToBottom();
            msgLen=msgData.length;
            //setTimeout(autoMessage,1000*10);
        });
    };

function back(){
    if(parent.showStatusBar)
        parent.showStatusBar();
    self.location="more.html";
}

function getHttp(){
    var url=location.search;
    if(!url)return {};
    url=url.split("?")[1].split("&");
    var arr=new Array();
    var n=url.length;
    for(var i=0;i<n;i++){
        arr[url[i].split("=")[0]]=decodeURIComponent(url[i].split("=")[1]);
    }
    return arr;
}

//如果是点击通知栏进入的，则执行
if(getHttp().from=="index.html"){
    //覆写back()
    back=function(){
        self.location="userlist.html";
    }
    //添加状态栏空位
    $("body").css("padding-top","20px");
    $("header").css("top","20px");
}
    
//推送
    
//收到消息后，添加一条消息
function addMessage(data){
    var msg=data.msg;
    var chatId=data.chat_id;
    myDom.msgList.append('<div class="msg-item"><img class="msg-user-img" src="./image/chat_default_service.png" alt="" /><div class="msg-content"><div class="msg-content-inner">'+msg+'</div><div class="msg-content-arrow"></div></div></div>');
    scrollToBottom();
    msgData.unshift({
        content:msg,
        chat_id:chatId
    });
}
    
//寻找一个json中的msg属性,并返回msg的值（可递归遍历json内的json)
function getJsonMsg(json,item){
	for (items in json){
		if(items==item)
			return json[items];
		else if(typeof json[items]=="object"){
			var m=getJsonMsg(json[items],item);
			if(m)return m;
		}
	}
}
    
function onReceiveMessage(data){
    navigator.vibrate(150);
    var bToObj;
    if(typeof data=="string"){
        data=data.replace(/"{"/g,'{"').replace(/"}"/g,'"}');
        try{
            bToObj=JSON.parse(data);
        }catch(e){
            alert("收到一条消息，但解析出错了");
        }
    }else 
        bToObj=data;
    addMessage(bToObj);
}

/**
 *点击通知进入应用则直接跳到“我的消息”页面
 */
function onOpenNotification(event){
    autoMessage();
    window.plugins.jPushPlugin.setApplicationIconBadgeNumber(0);
}
    
document.addEventListener('deviceready',function(){
    window._alert=alert;
    alert=function(msg){
        navigator.notification.alert(
            msg,  // 显示信息
            null,         // 警告被忽视的回调函数
            '车联在线',            // 标题
            '确定'                  // 按钮名称
        );
    }
    
    /**
     *注册点击通知事件（如果用户是点击通知进入应用的则触发onOpenNotification）
     */
    document.addEventListener("jpush.receiveNotification", onReceiveMessage, false);
    document.addEventListener("jpush.openNotification", onOpenNotification, false);

    document.addEventListener("pause", function(){
        window.foreground=false;
    }, false);
    document.addEventListener("resume", function(){
        setTimeout("window.foreground=true;",1000);
    }, false);
    
    window.plugins.jPushPlugin.setApplicationIconBadgeNumber(0);
}, false);
</script>
</body>
</html>